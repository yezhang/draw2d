<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>读取一个字体文件的glyph数据（永）</title>
    <style>
      #container {
        position: relative;
        width: 540px; /* canvas width + 20px for the ruler */
        height: 540px; /* canvas height + 20px for the ruler */
      }
      #fontCanvas {
        position: absolute;
        top: 40px;
        left: 40px;
        width: 500px;
        height: 500px;
        border: 1px dashed #000;
        box-sizing: border-box;
      }
      #rulerX,
      #rulerY {
        position: absolute;
        background: #f0f0f0;
        font-size: 10px;
        color: #333;
      }
      #rulerX {
        top: 0;
        left: 40px;
        width: 500px;
        height: 40px;
      }
      #rulerY {
        top: 40px;
        left: 0;
        width: 40px;
        height: 500px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <canvas id="fontCanvas" width="500" height="500"></canvas>
      <canvas id="rulerX" width="500" height="40"></canvas>
      <canvas id="rulerY" width="40" height="500"></canvas>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opentype.js/1.3.3/opentype.min.js"></script>
    <script>
      async function loadFont(url) {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const font = opentype.parse(arrayBuffer);
        return font;
      }
      function drawGrid(ctx, width, height, gridSize) {
        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = 1;

        for (let x = 0; x <= width; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }

        for (let y = 0; y <= height; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }
      }

      function drawRulerX(ctx, width, gridSize) {
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 1;
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        for (let x = 0; x <= width; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, 10);
          ctx.stroke();
          ctx.fillText(x, x, 15);
        }
      }

      function drawRulerY(ctx, height, gridSize) {
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 1;
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        for (let y = 0; y <= height; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(10, y);
          ctx.stroke();
          ctx.fillText(y, 15, y);
        }
      }

      async function drawGlyph(fontUrl, char) {
        const font = await loadFont(fontUrl);
        const glyph = font.charToGlyph(char);
        const canvas = document.getElementById("fontCanvas");
        const ctx = canvas.getContext("2d");
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const fontSize = Math.min(canvasWidth, canvasHeight) * 0.8; // 使字体大小适应画布

        const scale = fontSize / font.unitsPerEm;

        console.log("font", font);
        // 将 glyph 的信息打印到控制台
        console.log("glyph:", glyph);

        // 计算边界框的中心位置
        const bboxWidth = (glyph.xMax - glyph.xMin) * scale;
        const bboxHeight = (glyph.yMax - glyph.yMin) * scale;
        const x = (canvasWidth - bboxWidth) / 2 - glyph.xMin * scale;
        const y = (canvasHeight - bboxHeight) / 2 + glyph.yMax * scale;

        console.log("x:", x, "y:", y, "fontSize:", fontSize);

        const path = glyph.getPath(x, y, fontSize); // x, y, fontSize

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid(ctx, canvasWidth, canvasHeight, 50); // 绘制网格背景，网格大小为 50

        path.stroke = "red";
        path.fill = "transparent";
        path.draw(ctx);

        // glyph.draw(ctx, x, 400, fontSize, font);
        glyph.drawPoints(ctx, x, y, fontSize, font);
        glyph.drawMetrics(ctx, x, y, fontSize);
      }

      function drawRulers() {
        const rulerX = document.getElementById("rulerX");
        const rulerY = document.getElementById("rulerY");
        const ctxX = rulerX.getContext("2d");
        const ctxY = rulerY.getContext("2d");
        drawRulerX(ctxX, rulerX.width, 20); // 绘制 X 轴坐标尺，网格大小为 50
        drawRulerY(ctxY, rulerY.height, 20); // 绘制 Y 轴坐标尺，网格大小为 50
      }

      drawRulers();

      drawGlyph("./STSong.ttf", "永");
    </script>
  </body>
</html>
